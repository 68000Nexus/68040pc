\documentclass{article}

%\usepackage[letterpaper, margin=1in]{geometry}
\usepackage[letterpaper]{geometry}
\usepackage{bold-extra}
\usepackage{bytefield}
\usepackage{tabularx}
\usepackage{threeparttable}
\usepackage{xifthen}
\usepackage{xparse}
\usepackage{xspace}

\newcommand{\systemname}[0]{Baby040\xspace}

\makeatletter
\newcommand*{\textoverline}[1]{$\overline{\hbox{#1}}\m@th$}
\makeatother

\newcommand{\textss}[1]{$_{\hbox{#1}}$}

\NewDocumentCommand{\addr}{mm}{%
  \IfNoValueTF{#2}
  	{\texttt{\$#1}}
	{\mbox{\texttt{\$#1}-\texttt{\$#2}}}
}

\newcommand{\memsection}[4]{
	\bytefieldsetup{bitheight=#3\baselineskip}
	\bitbox[]{10}{
		\texttt{#1}
		\\ \vspace{#3\baselineskip} \vspace{-2\baselineskip} \vspace{- #3pt}
		\texttt{#2}
	}
	\bitbox{16}{#4}
}

\setlength\parindent{0pt}
\begin{document}

\begin{titlepage}
	\begin{center}
		\vspace*{1cm}

		\Huge
		\textbf{\systemname Specification}

		\vspace{0.5cm}
		\LARGE
		A Personal Computer Platform

		\vspace{1.5cm}
		\textbf{Anthony Guerrero}

		\vfill

		\normalsize
		Document Revision 0.0.1

		\vspace{0.8cm}
	\end{center}
\end{titlepage}

\section{System Overview}

\subsection{Design Goal}
The primary objective of the \systemname is to construct a personal computer
platform that aligns with the capabilities and aesthetics of computing systems
from the 1990s. The system is not merely a reflection of retro hardware but a
modern interpretation emphasizing complete transparancy, user understanding,
and modifiability. The design principles prioritize open-source documentation,
source code, and hardware description language (HDL) to empower users and
enthusiasts to understand, modify, and expand upon the system.

\subsection{Key Features}
\begin{itemize}
	\item \textbf{Open Architecture:} An open-source ethos is at the core of the
	project. All documentation, designs, and code associated with this
	system will be freely accessible and modifiable by the end-users and
	community.

	\item \textbf{MC68040 Processor:} Serving as the heart of the system, this 32-bit
	microprocessor offers a blend of performance and functionality suitable
	for a wide range of computing tasks. It's Instruction Set Architecture
	(ISA) and built-in MMU lends itself well to implementing UNIX-like
	operating systems.

	\item \textbf{Flexible Expansion:} The platform is designed with expansion and
	modularity in mind, featuring an ``Expansion Bus'' architecture to
	facilitate the addition of new components. The bus dynamically assigns
	memory space to bus members, bypassing address conflicts and setup
	jumpers.

	\item \textbf{Integrated FPGA:} Utilizing the iCE40-HX4K FPGA, with full access
	to the CPU bus, most glue logic and peripheral controllers can be
	implemented and modified after the design is finalized.

	\item \textbf{512MB Dynamic RAM:} With four 72-pin SIMM slots, the platform
	supports up to 512MB of main system memory. (3.3v only!)

	\item \textbf{Standard Form Factor:} The PCB will be sized to fit in a pre-ATX
	form factor called ``Baby AT''. This allows for eight expansion slots,
	a DIN-5 sized cutout for a keyboard, and simple power management.
\end{itemize}

\subsection{System Philosophy}

Beyond the technical specifications, this project embodies a philosophy of
transparency, education, and user empowerment. The system is not just a
computing platform but a testament to the ethos that technology should be
understandable, modifiable, and, above all, open. Whether for education,
nostalgia, or innovation, this platform seeks to be a canvas for users to
explore the intricacies of computing, reminiscent of an era when personal
computing was just blossoming.

\section{Hardware}

\subsection{CPU}

The Motorola MC68040 was chosen because I found it in a box. Control circuitry
on the motherboard asserts the \textoverline{MDIS} and \textoverline{IPLx} lines
on processor reset to configure it for non-multiplexed bus, small output buffer,
and data latch enable modes disabled. This allows for easy compatibility with
the LC and EC versions of the MC68040 and these features aren't required for
the system.

\subsection{SRAM}

There are 512KB of SRAM for boot ROM, et al...

\subsection{DRAM}

Four 72-pin SIMM slots provide the bulk RAM for the system. Each SIMM's
\textoverline{RAS} lines are tied together and sent to the memory controller,
\textoverline{CAS} lines are routed separately. The memory controller only
supports 3.3v SIMMs (TODO)

The SIMMs I have (Keystron MK16DS3232LP-50) have (16) 16M $\times$ 4-bit DRAMs
per module. (Place chip to \textoverline{CAS}, \textoverline{RAS}, DQ here)

\subsection{I2C Bus}

I2C is used on-board for communication with the Real-Time Clock (DS1307) and
other devices. (Temperature sensors/Fan controllers, etc.)

\section{Memory Map}

Pay no attention to the memory map diagram at Figure \ref{map:sysmem}, it's
probably inaccurate.

\vspace{12pt}

When \textoverline{RESET} is asserted from a reboot, power-up, etc., the address
decoder maps addresses \mbox{\texttt{\$00000000-\$000003FF}} to
\mbox{\texttt{\$8000FC00-\$8000FFFF}}. This allows the processor to read the
exception vector table from ROM, but writes to these addresses will be routed to
RAM. Once the system RAM test passes, the boot program copies the table to
system RAM and writes to a configuration register which remaps all accesses from
\texttt{\$00000000} to RAM.

\begin{figure}[]
	\caption{System Memory Map}
	\label{map:sysmem}
	\vspace{2ex}
	\begin{bytefield}{12}
		\memsection{0000 0000}{1fff ffff}{12}{DRAM}\\
		\memsection{2000 0000}{200f ffff}{3}{SRAM}\\
		\memsection{}{}{6}{-}\\
		\memsection{8000 0000}{8000 ffff}{2}{ROM}\\
		\memsection{}{ffff ffff}{3}{-}\\
	\end{bytefield}
\end{figure}

\section{Local Bus}

Standard 68040 bus, DRAM data is buffered through FPGA, MC68150 bus resizer for
expansion bus, I2C provided by PCA9564...

\section{Expansion Bus}

The system provides a Zorro III-inspired expansion slot bus, the main feature of
which is dynamic memory mapping of add-in devices. 

\subsection{Design Goals}

\begin{itemize}
	\item \textbf{Expansion and Flexibility:} A primary aim of the expansion
	bus is to ensure that the design does not inherently limit future
	enhancements or adaptations.

	\item \textbf{Performance:} While the exact performance target is yet to
	be finalized, the system aims to achieve robust performance comparable
	to 1990s standards.

	\item \textbf{Support for Varied Devices:} The bus should accomodate
	different devices, including those with different data widths.

	\item \textbf{Reliability:} Ensure robust operation and avoid
	complications that might make the system prone to errors.
\end{itemize}

\subsection{Bus Architecture}

The design of the expansion bus draws heavily from the Zorro III expansion bus
designed for the Amiga 3000 series of computers, but differs in many key ways
which make it incompatible.

The address and data bus are not multiplexed in this design, making use of the
generous conductor count provided by the DIN 41612 connectors.

The bus system is designed for potential synchronous operation at the BCLK rate,
but a lower frequency, like 10MHz, is also under consideration for ease of
implementation and broader device compatibility.

\subsubsection{Card Configuration}

Cards must ground the \textoverline{CDET} line to be included in the
bus, and therefore is a requirement for complying with this bus specification.
If the card doesn't pull this line down, or there isn't a card plugged into an
expansion slot, the \textoverline{CFGIN} line will be bridged to the
\textoverline{CFGOUT} line for that expansion slot.

\subsubsection{Bus Cycles}

\subsubsection{Arbitration/Mastering}

\subsubsection{Cache Support}

While the expansion bus doesn't have any cache consistency mechanisms for
managing caches between several caching bus masters, it does allow cards that
absolutely must not be cached to assert a cache inhibit line,
\textoverline{CI}, on a per-cycle basis. This cache management is mainly useful
for support of I/O and other devices that shouldn't be cached.

\subsubsection{Interrupts}

A card supporting interrupts has on-board registers to store one or more vector
numbers. The numbers are obtained from the OS by the device driver for the card
and the card/driver combination must be able to handle the situation in which no
additional vectors are available.

\subsection{Signal Description}

\subsubsection{Power Connections}

\begin{itemize}
	\item{\textbf{Digital Ground (GND)}} This is the digital supply ground
	used by all expansion cards as the return path for all expansion
	supplies.

	\item{\textbf{Main Supply (+5VDC)}} This is the main power supply for
	all expanion cards. (Define power specification)

\end{itemize}

\subsubsection{Clock Signals}

\begin{itemize}
	\item{\textbf{TBD...}}
\end{itemize}

\subsubsection{System Control Signals}

\begin{itemize}
	\item{\textbf{Hardware Bus Error}}

	\item{\textbf{System Interrupts}}
\end{itemize}

\subsubsection{Slot Control Signals}

\begin{itemize}

	\item{\textbf{Configuration Chain
	(\textoverline{\scshape CFGINn},
	\textoverline{\scshape CFGOUTn})}} The slot configuration mechanism uses
	the bus signals \textoverline{\scshape CFGOUTn} and
	\textoverline{\scshape CFGINn}, where ``\textsc{n}'' refers to the slot
	number. Each slot has its own version of both signals, which make up the
	\textit{configuration chain} between slots. Each subsequent
	\textoverline{CFGIN} is a result of all previous
	\textoverline{CFGOUT}s, going from slot 0 to the last slot on the
	expansion bus.

	During the autoconfiguration process, an unconfigured card responds to
	the address space X if its \textoverline{\scshape CFGINn} is asserted.
	All unconfigured cards start up with \textoverline{\scshape CFGOUTn}
	negated. When configured, a card will assert its
	\textoverline{\scshape CFGOUTn} which results in the
	\textoverline{\scshape CFGINn} of the next slot being asserted.
	Backplane logic automatically passes on the state of the previous
	\textoverline{\scshape CFGOUTn} to the next
	\textoverline{\scshape CFGINn} for any slot not occupied by a card.

	\item{\textbf{Card Detect (\textoverline{CDET})}} This signal is to
	always be attached to ground by cards to allow them to participate in
	the expansion bus. This signal is part of the backplane circuitry that
	allows the configuration chain to function.

\end{itemize}

\subsubsection{DMA Control Signals}

\begin{itemize}
	\item{\textbf{TBD...}}
\end{itemize}

\subsubsection{Address and Related Control Signals}

\begin{itemize}

	\item{\textbf{Address Bus (A\textss{0}-A\textss{31})}} This is the
	expansion address bus, which is driven by the bus master.

\end{itemize}

\subsubsection{Data and Related Control Signals}

\begin{itemize}
	\item{\textbf{Data Bus (D\textss{0}-D\textss{31})}} This is the
	expansion data bus, which is driven by either the master or the slave
	when ``'' is asserted by the master. It's valid for reads when
	\textoverline{DTACK} is asserted by the slave.

	\item{\textbf{Data Transfer Acknowledge (\textoverline{DTACK})}} This
	signal is used to normally terminate an expansion bus cycle. The slave
	is always responsible for driving this signal. For a read cycle, it
	asserts \textoverline{DTACK} as soon as it has driven valid data onto
	the bus. For a write cycle, it asserts \textoverline{DTACK} as soon as
	it's dont with the data.

	\item{\textbf{Cache Inhibit (\textoverline{CI})}} This line is asserted
	at the same time as ``'' to indicate to the bus master that the cycle
	must not be cached.

	\item{\textbf{Burst Inhibit (\textoverline{BI})}} This line is asserted
	at the same time as ``'' to indicate to the bus master that the
	requested burst (MOVE16) cycle should be done as four 32-bit transfers.
	This line is only used for 32-bit add-in cards.
\end{itemize}

\subsection{Electrical Specifications}

\subsubsection{Standard Signals}

The majority of signals on the bus are in this group. These are the bussed
signals, driven actively on the bus by F-series (or compatible) drivers, usually
tri-stated when ownership of the signal changed for master and slave, and
generally terminated with a 220$\Omega$/330$\Omega$ thevenin terminator.

\begin{center}
	\begin{tabularx}{0.75\textwidth}{X X X}
		A\textss{0}-A\textss{31} & D\textss{0}-D\textss{31} & R/\textoverline{W} \\
		FC\textss{0}-FC\textss{2} & & 
	\end{tabularx}
\end{center}

\subsubsection{Clock Signals}

\subsubsection{Open Collector Signals}

Many of the bus signals are shared via open collector or open drain outputs
rather than via tri-stated signals. A backplane resistor pulls these lines high,
cards only drive the line low.

\begin{center}
	\begin{tabularx}{0.75\textwidth}{X X X}
		\textoverline{DTACK} & \textoverline{CI} & \textoverline{BI} \\
		\textoverline{RESET} & \textoverline{INT} & 
	\end{tabularx}
\end{center}

\subsubsection{Non-bussed signals}

\subsubsection{Slot Power Availability}

The system power for the expansion bus is based on the slot configurations. A
backplane is always free to supply extra power, but it must meet the minimum
requirements specified here. All cards must be designed with the minimum
specifications in mind, especially the tolerances.

\begin{center}
	\begin{tabularx}{0.75\textwidth}{X X}
		Pin & Supply \\
		\hline \\
		X, X	& $+$5 VDC $\pm$5\% @ 2A \\
		X	& $-$5 VDC $\pm$5\% @ 60mA \\
		X	& $+$12 VDC $\pm$5\% @ 500mA \\
		X	& $-$12 VDC $\pm$5\% @ 60mA \\
	\end{tabularx}
\end{center}



\subsection{Mechanical Specifications}

\subsection{Expansion Slot Pin Assignments}

%\begin{figure}[h]
	\begin{centering}

	\begin{threeparttable}
	\caption{Expansion Bus Connector Pinout}
	\begin{tabularx}{\textwidth}
		{| c | X || c | X || c | X |}
		\hline
		Pin & Name & Pin & Name & Pin & Name \\
		\hline\hline
		a1  & NC\tnote{1}	& b1  &	NC		& c1  &	NC 		\\
		\hline
		a2  & NC		& b2  &	NC		& c2  &	NC 		\\
		\hline
		a3  & NC		& b3  &	NC		& c3  &	NC 		\\
		\hline
		a4  & NC		& b4  &	NC		& c4  &	NC 		\\
		\hline
		a5  & NC		& b5  &	NC		& c5  &	NC 		\\
		\hline
		a6  & NC		& b6  &	NC		& c6  &	NC 		\\
		\hline
		a7  & NC		& b7  &	NC		& c7  &	NC 		\\
		\hline
		a8  & NC		& b8  &	NC		& c8  &	NC 		\\
		\hline
		a9  & NC		& b9  &	NC		& c9  &	NC 		\\
		\hline
		a10 & NC		& b10 &	NC		& c10 &	NC 		\\
		\hline
		a11 & NC		& b11 &	NC		& c11 &	NC 		\\
		\hline
		a12 & NC		& b12 &	NC		& c12 &	NC 		\\
		\hline
		a13 & NC		& b13 &	NC		& c13 &	NC 		\\
		\hline
		a14 & NC		& b14 &	NC		& c14 &	NC 		\\
		\hline
		a15 & NC		& b15 &	NC		& c15 &	NC 		\\
		\hline
		a16 & NC		& b16 &	NC		& c16 &	NC 		\\
		\hline
		a17 & NC		& b17 &	NC		& c17 &	NC 		\\
		\hline
		a18 & NC		& b18 &	NC		& c18 &	NC 		\\
		\hline
		a19 & NC		& b19 &	NC		& c19 &	NC 		\\
		\hline
		a20 & NC		& b20 &	NC		& c20 &	NC 		\\
		\hline
		a21 & NC		& b21 &	NC		& c21 &	NC 		\\
		\hline
		a22 & NC		& b22 &	NC		& c22 &	NC 		\\
		\hline
		a23 & NC		& b23 &	NC		& c23 &	NC 		\\
		\hline
		a24 & NC		& b24 &	NC		& c24 &	NC 		\\
		\hline
		a25 & NC		& b25 &	NC		& c25 &	NC 		\\
		\hline
		a26 & NC		& b26 &	NC		& c26 &	NC 		\\
		\hline
		a27 & NC		& b27 &	NC		& c27 &	NC 		\\
		\hline
		a28 & NC		& b28 &	NC		& c28 &	NC 		\\
		\hline
		a29 & NC		& b29 &	NC		& c29 &	NC 		\\
		\hline
		a30 & NC		& b30 &	NC		& c30 &	NC 		\\
		\hline
		a31 & NC		& b31 &	NC		& c31 &	NC 		\\
		\hline
		a32 & NC		& b32 &	NC		& c32 &	NC 		\\
		\hline
	\end{tabularx}
	\begin{tablenotes}
	\item [1] This means it's not connected.
	\end{tablenotes}
	\end{threeparttable}
	\end{centering}
% \end{figure}

\section{Interrupt System}

\section{Special Thanks}

\textbf{Ben Eater} for creating engaging videos on computer engineering,
inspiring me to build a computer of my own.

\textbf{Lawrence Manning} MAXI030

\textbf{Stephen Moody} Y Ddraig(030)

\textbf{Dave Haynie} Author of "The Zorro III Bus Specification"

\end{document}
